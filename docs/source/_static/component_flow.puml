@startuml

title WRT Stackless Execution Flow (with Fuel)

participant "WRTD CLI" as CLI
participant "StacklessEngine" as Engine
participant "Module" as Module
participant "Validation" as Validation
participant "Stackless Execution" as Execution /' Internal to StacklessEngine '/
participant "Memory" as Memory

CLI -> Module: load_from_binary(bytes)
Module -> Validation: validate()

CLI -> Engine: instantiate(module)
Engine -> Module: instantiate()
Engine --> CLI: instance ID

CLI -> Engine: set_fuel(amount)
CLI -> Engine: execute(instance_id, func_idx, args)
activate Engine

Engine -> Execution: initialize_state(args)
activate Execution

loop until completion or out of fuel
  Execution -> Execution: process_instruction()
  Execution -> Memory: read/write data
  
  alt out of fuel condition
    Execution --> Engine: FuelExhausted error
    Engine --> CLI: FuelExhausted error
    deactivate Execution
    deactivate Engine
    stop
  end
end

Execution --> Engine: execution results
deactivate Execution

Engine --> CLI: function results
deactivate Engine

@enduml